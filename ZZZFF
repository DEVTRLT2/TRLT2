local TreeManager = {}

local RmotNofi = game:GetService("ReplicatedStorage").Notices.SendUserNotice

function TreeManager.NOTIF(te)
	RmotNofi:Fire(te)
end
-- Load Database Axe (External)
local success, moduleAxe = pcall(function()
    return loadstring(game:HttpGet("https://raw.githubusercontent.com/DEVTRLT2/TRLT2/refs/heads/main/AXE.lumberTyccon2"))()
end)

if not success then
    TreeManager.NOTIF("Module Axe Nya Ada Yang ERROR")
    moduleAxe = {} 
end

-- Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService") -- Service baru ditambahkan

local LocalPlayer = Players.LocalPlayer
local Interaction = ReplicatedStorage:WaitForChild("Interaction")
local RemoteProxy = Interaction:WaitForChild("RemoteProxy")
local ClientIsDragging = Interaction:WaitForChild("ClientIsDragging")

-- // HELPER FUNCTIONS // --

local function SetPrimaryPart(model)
    if model.PrimaryPart then return end
    for _, v in pairs(model:GetChildren()) do
        if v.Name == "WoodSection" and v:FindFirstChild("ID") and v.ID.Value == 1 then
            model.PrimaryPart = v
            return
        end
    end
end

local function BringWoodToPos(woodModel, targetCFrame)
    SetPrimaryPart(woodModel)
    if not woodModel.PrimaryPart then return end

    for i = 1, 5 do
        ReplicatedStorage.TestPing:InvokeServer()
    end

    task.spawn(function()
        for i = 1, 20 do
            ClientIsDragging:FireServer(woodModel)
        end
    end)

    for i = 1, 20 do
        if woodModel.PrimaryPart then
            woodModel:PivotTo(targetCFrame)
        end
    end
end

-- // MODULE FUNCTIONS // --

function TreeManager.GetBestAxe(targetWood)
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    local character = LocalPlayer.Character
    if not backpack then return nil end

    local damageBest = -1
    local axeBest = nil
    
    local allTools = backpack:GetChildren()
    if character then
        for _, t in pairs(character:GetChildren()) do
            if t:IsA("Tool") then table.insert(allTools, t) end
        end
    end

    for _, tool in ipairs(allTools) do
        local toolNameObj = tool:FindFirstChild("ToolName")
        if toolNameObj and moduleAxe[toolNameObj.Value] then
            local axeName = toolNameObj.Value
            local axeStats = moduleAxe[axeName]

            if axeStats.SpecialTrees and axeStats.SpecialTrees[targetWood] then
                return tool
            end

            local currentDamage = axeStats.Damage or 0
            if currentDamage > damageBest then
                damageBest = currentDamage
                axeBest = tool
            end
        end
    end
    return axeBest
end

function TreeManager.ChopTree(targetClass)
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local rootPart = char:WaitForChild("HumanoidRootPart")
    local humanoid = char:WaitForChild("Humanoid")
    local savePos = rootPart.CFrame 

    -- 1. Cari Pohon
    local targetTree = nil
    for _, region in pairs(Workspace:GetChildren()) do
        if region.Name == "TreeRegion" then
            for _, tree in pairs(region:GetChildren()) do
                if tree:IsA("Model") and tree:FindFirstChild("TreeClass") and tree:FindFirstChild("Owner") then
                    if tree.TreeClass.Value == targetClass and tree.Owner.Value == nil and not tree:FindFirstChild("RootCut") then
                        if targetClass == "Generic" then
                            if #tree:GetChildren() > 4 then targetTree = tree break end
                        else
                            targetTree = tree break
                        end
                    end
                end
            end
        end
        if targetTree then break end
    end
	
    if not targetTree then
        TreeManager.NOTIF(targetClass.."Tidak Ditemukan")
        return false -- Gagal
    end

    -- 2. Cari Axe & Stats
    local tool = TreeManager.GetBestAxe(targetClass)
    if not tool then return false end

    if tool.Parent == LocalPlayer.Backpack then tool.Parent = char end

    local axeStats = moduleAxe[tool.ToolName.Value]
    local cooldown = axeStats.SwingCooldown
    local damage = axeStats.Damage

    if axeStats["SpecialTrees"] and axeStats.SpecialTrees[targetClass] then
        local axest = axeStats.SpecialTrees[targetClass]
        cooldown = axest.SwingCooldown
        damage = axest.Damage
    end

    -- 3. Setup Teleport Loop
    local woodSection = nil
    for _, v in pairs(targetTree:GetChildren()) do
        if v.Name == "WoodSection" and v:FindFirstChild("ID") and v.ID.Value == 1 then
            woodSection = v; break
        end
    end
    if not woodSection then return false end

    local teleportLoop
    local function StopTeleport()
        if teleportLoop then teleportLoop:Disconnect(); teleportLoop = nil end
        rootPart.AssemblyLinearVelocity = Vector3.zero
        rootPart.AssemblyAngularVelocity = Vector3.zero
    end

    teleportLoop = RunService.Heartbeat:Connect(function()
        if char and rootPart then
            rootPart.CFrame = woodSection.CFrame
            rootPart.AssemblyLinearVelocity = Vector3.zero 
            rootPart.AssemblyAngularVelocity = Vector3.zero
        else
            StopTeleport()
        end
    end)

    -- 4. Variabel Kontrol untuk Menunggu
    local isChopping = true
    local processFinished = false -- Variable kunci agar script menunggu

    -- Fungsi Menebang
    task.spawn(function()
        while isChopping and targetTree and not targetTree:FindFirstChild("RootCut") do
            local cutEvent = targetTree:FindFirstChild("CutEvent")
            if cutEvent then
                RemoteProxy:FireServer(cutEvent, {
                    ['tool'] = tool,
                    ['faceVector'] = Vector3.new(1, 0, 0),
                    ['height'] = 0.3,
                    ['sectionId'] = 1,
                    ['hitPoints'] = damage,
                    ['cooldown'] = cooldown,
                    ['cuttingClass'] = 'Axe'
                })
            end
            task.wait(cooldown + 0.1)
        end
    end)

    -- 5. Deteksi Pohon Jatuh & Proses Bring
    local connection
    connection = Workspace.LogModels.ChildAdded:Connect(function(child)
        local owner = child:WaitForChild("Owner", 5)
        if owner and owner.Value == LocalPlayer then
            isChopping = false 
            connection:Disconnect()
            
            print("Pohon tumbang, membawa kayu...")
            task.wait(0.5)
            
            -- Proses BringWood
            local bringTime = tick()
            while tick() - bringTime < 4 do -- Durasi bawa kayu 4 detik
                 if child.Parent then 
                    BringWoodToPos(child, savePos)
                 end
                 task.wait()
            end
            
            StopTeleport() 
            rootPart.CFrame = savePos
            humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
            
            processFinished = true -- Menandakan proses SELESAI TOTAL
        end
    end)
    
    -- Timeout safety jika pohon tidak kunjung tumbang
    task.delay(35, function()
        if not processFinished then
            if connection then connection:Disconnect() end
            isChopping = false
            StopTeleport()
            processFinished = true -- Paksa lanjut meskipun gagal agar tidak stuck
        end
    end)

    -- // BAGIAN PALING PENTING // --
    -- Script akan "Nyangkut" di sini sampai processFinished bernilai true
    repeat task.wait(0.1) until processFinished == true
    return true
end

function TreeManager.PickUpAxe(axe)
	game:GetService("ReplicatedStorage").Interaction.ClientInteracted:FireServer(axe,'Pick up tool')
end
function TreeManager.ChopLoneCave()
	local axestas = moduleAxe
	local treelone = nil
	local toolendtime = nil
	for _,v in pairs(workspace:GetChildren()) do
		if v.Name == "TreeRegion" then
			for _,se in pairs(v:GetChildren()) do
				if se:IsA("Model") then
					if se:FindFirstChild("Owner") and se:FindFirstChild("TreeClass") then
						if se:FindFirstChild("Owner").Value == nil and se:FindFirstChild("TreeClass").Value == "LoneCave" then
							treelone = se
						end
					end
				end
			end
		end
	end
	for _,v in pairs(game.Players.LocalPlayer.Backpack:GetChildren()) do
		if v:FindFirstChild("ToolName") then
			local nama = v:FindFirstChild("ToolName")
			if nama.Value == "EndTimesAxe" then
				toolendtime = v
			end
		end
	end
	if treelone == nil then TreeManager.NOTIF("LoneCave Nya Ga Ada") return end
	if toolendtime == nil then TreeManager.NOTIF("Axe End Time Mana?") return end
	print("Lanjut")
	if treelone ~= nil and toolendtime ~= nil then
		print("CHOP IT")
	end
end

return TreeManager
